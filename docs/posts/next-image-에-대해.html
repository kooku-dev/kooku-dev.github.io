<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/><link rel="shortcut icon" href="/favicon.ico"/><script>
            (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
            })(window,document,'script','dataLayer','GTM-KDDR59L');
              </script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-88SF4487LG"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-88SF4487LG');
              </script><title>Kooku&#x27;s log - next/image 에 대해</title><meta property="og:logo" content="https://kooku94.github.io/favicon.ico"/><meta property="og:title" content="next/image 에 대해"/><meta property="og:image" content="https://kooku94.github.ioundefined"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:type" content="article"/><meta name="next-head-count" content="14"/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-6ea43f52d44630a19477.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.b4f0be21e3e8c82dd407.js" as="script"/><link rel="preload" href="/_next/static/chunks/b6d3ae6728fbe7f18c7a496885d917c502ef8a97.f1fb57fac8faffcae7e5.js" as="script"/><link rel="preload" href="/_next/static/chunks/82588f7d1c9cede2e30aa92ab94d8815bd9a75a3.d8beab73fc47c8ecaab9.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-2cd9b9378ad45e0c3d1d.js" as="script"/><link rel="preload" href="/_next/static/chunks/b2e984c5.dde205419b836c367968.js" as="script"/><link rel="preload" href="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.0d2a9ee544564bfee014.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-7d175a24f37cfddaca2b.js" as="script"/></head><body><div id="__next"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KDDR59L" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><style data-emotion="css-global 1g30n2o">*{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;box-sizing:border-box;}html,body{font-family:'Spoqa Han Sans Neo',sans-serif!important;margin:0;padding:0;border:0;}html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,menu,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,main,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;vertical-align:baseline;}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block;}*[hidden]{display:none;}body{line-height:1;}input::-ms-clear,input::-ms-reveal{display:none;width:0;height:0;}input::-webkit-search-decoration,input::-webkit-search-cancel-button,input::-webkit-search-results-button,input::-webkit-search-results-decoration{display:none;}*:active{-webkit-tap-highlight-color:transparent;outline:none;}*:focus{outline:0;}a{-webkit-text-decoration:none;text-decoration:none;}input[type='number']::-webkit-outer-spin-button,input[type='number']::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}button,*[role='button']{cursor:pointer;}</style><style data-emotion="css bjn8wh">.css-bjn8wh{position:relative;}</style><div class="css-bjn8wh ep629fi11"><style data-emotion="css 1mwsm5">.css-1mwsm5{background:linear-gradient(72deg, #6ecaf5, #e7c6f1);position:-webkit-sticky;position:sticky;left:0;right:0;top:0;z-index:999;}</style><div class="css-1mwsm5 e1ohtyx52"><style data-emotion="css 1518suw">.css-1518suw{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:60px;}@media (min-width: 1024px){.css-1518suw{max-width:1024px;margin:0 auto;}}@media (min-width: 768px) and (max-width: 1023px){.css-1518suw{max-width:960px;margin:0 32px;}}@media (max-width: 767px){.css-1518suw{max-width:100%;margin:0 16px;}}</style><nav class="css-1518suw e1ohtyx51"><style data-emotion="css itptq8">.css-itptq8{color:#ffffff;opacity:0.7;font-size:28px;font-weight:800;}</style><h3 role="button" tabindex="0" class="css-itptq8 e1ohtyx50">Kooku&#x27;s log</h3><style data-emotion="css 1p39xhz">.css-1p39xhz{float:right;padding:14px;opacity:0.6;}</style><a href="https://github.com/kooku94" aria-label="GitHub" class="css-1p39xhz"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></nav></div><style data-emotion="css 15jvohm">@media (min-width: 1024px){.css-15jvohm{max-width:1024px;margin:auto;}}@media (min-width: 768px) and (max-width: 1023px){.css-15jvohm{margin:0 16px;}}</style><article class="css-15jvohm ep629fi9"><style data-emotion="css 1cfjemv">.css-1cfjemv{position:relative;padding-bottom:32px;}@media (min-width: 1024px){.css-1cfjemv{max-width:780px;margin:0 auto;}}@media (min-width: 768px) and (max-width: 1023px){.css-1cfjemv{max-width:780px;margin:0 32px;}}@media (max-width: 767px){.css-1cfjemv{max-width:100%;}}@media (max-width: 767px){.css-1cfjemv{margin:0 16px;}}</style><section class="css-1cfjemv ep629fi8"><style data-emotion="css 1d0nbku">.css-1d0nbku{margin-top:24px;}</style><div class="css-1d0nbku ep629fi7"><style data-emotion="css tl449l">.css-tl449l{color:#8d949f;font-size:14px;font-weight:bold;line-height:1.57;margin-right:8px;}</style><span class="css-tl449l ep629fi6">next.js</span></div><header><style data-emotion="css ljp8x3">.css-ljp8x3{color:#000000;margin:8px 0 24px 0;font-size:26px;font-weight:bold;line-height:1.2;}</style><h1 class="css-ljp8x3 ep629fi5">next/image 에 대해</h1></header><style data-emotion="css 1829sa1">.css-1829sa1{color:#535a65;font-size:16px;font-weight:normal;line-height:1.63;min-height:320px;}</style><div class="css-1829sa1 ep629fi4"><style data-emotion="css 16cgglh">.css-16cgglh time{color:#9b9b9b;}.css-16cgglh p{line-height:1.5rem;margin:1rem 0 0 0;}.css-16cgglh a{font-size:1rem;color:#358cd6;-webkit-text-decoration:underline;text-decoration:underline;}.css-16cgglh h1{font-size:2rem;margin:2.5rem 0 0 0;}.css-16cgglh h2,.css-16cgglh h3,.css-16cgglh h4,.css-16cgglh h5{margin:1.5rem 0 0.5rem 0;line-height:1.25em;}.css-16cgglh h2::before{position:absolute;margin-left:-1em;font-weight:300;font-size:1.5rem;color:#9b9b9b;display:none;content:'#';}.css-16cgglh img{width:100%;}.css-16cgglh table{max-width:100%;border-spacing:0;margin-top:1.5rem;}.css-16cgglh table thead{background:#f7f7f7;}.css-16cgglh table th{font-weight:500;}.css-16cgglh table th,.css-16cgglh table td{padding:0.5em 1em;border:1px double #eee;}.css-16cgglh ul{list-style-type:disc;}.css-16cgglh ol{list-style-type:decimal;}.css-16cgglh ul ul,.css-16cgglh ol ul{list-style-type:circle;}.css-16cgglh blockquote{border-left:3px solid rgb(239, 240, 244);margin:15px 0;padding-left:16px;}.css-16cgglh blockquote p{margin-top:0;}.css-16cgglh ol,.css-16cgglh ul{padding:0 0 0 1.5rem;margin:1.5rem 0 0 0;margin:0;}.css-16cgglh ol li,.css-16cgglh ul li{line-height:1.5rem;margin:0;}.css-16cgglh .youtube-container{position:relative;width:100%;height:0;padding-bottom:56.25%;overflow:hidden;margin:20px 0;}.css-16cgglh .youtube-container iframe{width:100%;height:100%;position:absolute;top:0;left:0;}.css-16cgglh iframe{position:absolute;top:0;left:0;width:100%;height:100%;}.css-16cgglh p>code{padding:0.1rem 0.3rem;border-radius:4px;background-color:#f2f5fc;color:#275fc8;font-size:1rem;font-weight:bold;}.css-16cgglh pre{padding:1.2em;margin:1.5em 0;overflow:auto;border-radius:0.6em;color:#e0e0e0;background:#212121;font-family:'Consolas','Monaco','Andale Mono','Ubuntu Mono',monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.6;font-size:13px;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;-ms-overflow-style:none;overflow:-moz-scrollbars-none;}.css-16cgglh code[class*='language-'],.css-16cgglh pre[class*='language-']{color:#e0e0e0;background:none;font-family:'Consolas','Monaco','Andale Mono','Ubuntu Mono',monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.6;font-size:13px;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;-ms-overflow-style:none;overflow:-moz-scrollbars-none;}.css-16cgglh pre[class*='language-']::-webkit-scrollbar{display:none;}.css-16cgglh pre[class*='language-']{padding:1.2em;margin:1.5em 0;overflow:auto;border-radius:0.6em;}.css-16cgglh:not(pre)>code[class*='language-'],.css-16cgglh pre[class*='language-']{background:#212121;}.css-16cgglh:not(pre)>code[class*='language-']{padding:0.1em 0.6em;border-radius:0.2em;white-space:normal;background:$inline-dimmed-color;color:$inline-text-color;}.css-16cgglh .token.comment,.css-16cgglh .token.block-comment,.css-16cgglh .token.prolog,.css-16cgglh .token.doctype,.css-16cgglh .token.cdata{color:#868282;}.css-16cgglh .token.punctuation{color:#e0e0e0;}.css-16cgglh pre[class*='language-'] .tag{color:#358cd6;}.css-16cgglh .token.attr-name{color:#6196cc;}.css-16cgglh .token.namespace,.css-16cgglh .token.deleted{color:#e2777a;}.css-16cgglh .token.function-name{color:#6196cc;}.css-16cgglh .token.boolean{color:#358cd6;}.css-16cgglh .token.number{color:#b5ce98;}.css-16cgglh .token.function{color:#dcdcaa;}.css-16cgglh .token.property,.css-16cgglh .token.class-name,.css-16cgglh .token.constant,.css-16cgglh .token.symbol{color:#4ec9b2;}.css-16cgglh .token.selector,.css-16cgglh .token.important,.css-16cgglh .token.atrule,.css-16cgglh .token.keyword,.css-16cgglh .token.builtin{color:#c586c0;}.css-16cgglh .token.string,.css-16cgglh .token.char,.css-16cgglh .token.attr-value,.css-16cgglh .token.regex,.css-16cgglh .token.variable{color:#ce9178;}.css-16cgglh .token.operator,.css-16cgglh .token.entity,.css-16cgglh .token.url{color:#67cdcc;}.css-16cgglh .token.important,.css-16cgglh .token.bold{font-weight:bold;}.css-16cgglh .token.italic{font-style:italic;}.css-16cgglh .token.entity{cursor:help;}.css-16cgglh .token.inserted{color:green;}</style><div class="css-16cgglh ep629fi3"><p>Brand site를 개발하며 SEO를 높히기 위해 기존 Vue.js로 되어있는 프로젝트를 next.js 로 프레임워크를 변경하는 작업을 진행한 경험이 있습니다. 이때 새로운 프레임워크로 Next.js를 선택한 배경으로는 새로운 v10이 나왔기도 했고, 가장 인기있는 프레임워크 중 하나이기 때문입니다.</p>
<p>Next.js가 이번 v10이 나오게 되면서 많은 기능들이 추가 되었는데, 그 중 가장 관심이 갔던게 <a href="https://nextjs.org/blog/next-10#built-in-image-component-and-automatic-image-optimization"><code>next/image</code></a> 입니다.</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Image</span></span> <span class="token keyword module">from</span> <span class="token string">'next/image'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Home</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">My Homepage</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">Image</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/me.png<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Picture of the author<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">500</span><span class="token punctuation">}</span></span> <span class="token attr-name">height</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">500</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">Welcome to my homepage!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token maybe-class-name">Home</span><span class="token punctuation">;</span>
</code></pre>
<p><code>next/image</code>는 next.js에서 제공하는 이미지 최적화 컴포넌트입니다. <code>Static HTML Export</code>에서는 사용할 수 없는데, 그 이유는 Server에서 돌아가기 때문입니다.</p>
<h3><code>next/image</code>가 수행하는 기능은 다음과 같습니다.</h3>
<ul>
<li>webp 포멧으로 자동변환</li>
<li>automatic lazy-loading</li>
<li>correct sizing across devices</li>
</ul>
<p>자동 이미지 최적화 기능이 매우 흥미로운데, image request가 들어올 때마다 device 크기별로 이미지 크기(image quality)를 조절해서 보내줍니다.</p>
<p><img src="/images/next-image.png" alt="next-image-header"></p>
<p><code>next/image</code> header를 살펴보겠습니다.
실제 이미지는 <code>image/bg-kasa.png</code> path에 있지만 <code>_next/image</code> 로 요청된 것을 알 수 있습니다. query를 살펴보면 q=75 로 되어있는데 이는 image-quality를 75%로 보내달라는 것 입니다. 즉, 현재 viewport width가 크지 않으니 100% quality로 보내면 network상 손해이기 때문에 75%로 보내는 것 입니다. 그리고 업로드한 이미지는 파일포멧이 png인데, response headers를 보게되면 <code>Content-Type: image/webp</code> 인 것을 확인할 수 있습니다.(webp로 파일포멧 변경)</p>
<p><code>next/image</code>를 사용하면 브라우저에서 지원하는 경우 WebP와 같은 최신 형식의 이미지로 변환하여 전송하고, 이미지 크기를 조정하고 최적화할 수 있습니다. 이렇게 하면 viewPort가 더 작은 장치로 큰 이미지가 전송되는 것을 막을 수 있습니다.</p>
<p>생성 가능한 총 이미지 수를 줄이기 위해 <code>deviceSizes</code> 및 <code>imageSizes</code>를 구성 할 수도 있습니다.</p>
<pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  images<span class="token operator">:</span> <span class="token punctuation">{</span>
    deviceSizes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">750</span><span class="token punctuation">,</span> <span class="token number">828</span><span class="token punctuation">,</span> <span class="token number">1080</span><span class="token punctuation">,</span> <span class="token number">1200</span><span class="token punctuation">,</span> <span class="token number">1920</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">,</span> <span class="token number">3840</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    imageSizes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h2>memory leak</h2>
<p><code>next/image</code>에서 memory leak 문제가 지속적으로 제기 되었습니다.</p>
<ul>
<li><a href="https://github.com/vercel/next.js/issues/20915">https://github.com/vercel/next.js/issues/20915</a></li>
<li><a href="https://github.com/vercel/next.js/issues/23189">https://github.com/vercel/next.js/issues/23189</a></li>
</ul>
<p><code>next/image</code>에 의해 최적화된 이미지는 만료일에 도달할 때까지 <code>&#x3C;distDir>/cache/images</code>에 캐싱을 하고, 만료가 되면 캐싱된 이미지를 삭제하고 다시 최적화 이미지를 생성한 후 캐싱을 하는 기능이 있는데 이때 캐싱된 이미지를 삭제하는 라이브러리가 제대로 삭제를 시켜주지 않는 문제였습니다.</p>
<p>next.js 레포에 v9에서 v10으로 변경한 후 memory 사용량이 비정상적으로 높아졌으며 이로 인해 <code>next/image</code>의 image component를 제거해야만 했다라는 이슈가 계속 올라왔습니다.</p>
<p><img src="https://camo.githubusercontent.com/d88fbdef185b40d56b3a42a699550a469dbaa28f0ca50e2e344644900b972691/68747470733a2f2f692e696d6775722e636f6d2f434b54457863722e706e67" alt="img">
<img src="https://user-images.githubusercontent.com/13972013/104264344-72379580-5459-11eb-8285-7bb2a50adfa5.png" alt="img">
<img src="https://user-images.githubusercontent.com/6556627/105622606-adc25000-5dc7-11eb-8d65-130845bbbbd8.jpeg" alt="img"></p>
<p>이에 next.js에서는 캐싱하고 삭제하는 라이브러리와 로직을 계속 변경하고 테스트를 하는 중인 것 같습니다.(canary에서 memory-leak 관련 피쳐들이 계속 올라오고 있습니다.)</p>
<p>제가 이 문제를 알게된 이유도 현재 next 서버를 돌리고 있는 ecs(Amazon Elastic Container Services)의 cpu와 memory의 사용량이 비정상적인 경우가 존재하였고, image가 pending 상태로 제대로 받아지지 않고 ecs가 비정상적으로 종료되는 문제가 계속 발생했기 때문입니다.</p>
<p>다음은 제가 작업한 프로젝트에서 <code>next/image</code>를 사용했다가 제거한 후의 cpu, memory 사용량입니다. <strong>5/11 15:30</strong> 에 제거한 후 배포를 했는데 확연한 차이를 확인할 수 있습니다. (그래프가 요동치는 곳의 색깔이 화려한데 8개이상의 pod가 비정상적으로 종료되고 실행되었기 때문입니다.)</p>
<p><img src="/images/cpu.png" alt="cpu"></p>
<p><img src="/images/memory.png" alt="memory"></p>
<h2>마무리</h2>
<p>현재 next.js의 stable version은 v10.2.0 입니다. <code>next/image</code>는 분명히 좋은 기능이지만 위의 이슈가 해결되지 않는다면 production에서 사용하기에는 어려울 것 같습니다.</p></div></div><style data-emotion="css 9vkh6d">.css-9vkh6d{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;width:100%;margin-top:48px;}.css-9vkh6d button{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;width:240px;height:48px;border:none;margin:8px auto;border-radius:4px;font-size:16px;font-weight:bold;padding:16px;position:relative;}</style><div class="css-9vkh6d ep629fi2"><style data-emotion="css 1qw3ucq">.css-1qw3ucq{background-color:#e8f3ff;color:#1d6ff2;margin-bottom:16px;}.css-1qw3ucq>svg{position:absolute;left:16px;}</style><button class="like-button css-1qw3ucq ep629fi1"><svg viewBox="0 0 24 24" style="width:20;height:20" role="presentation" class="like-button"><path d="M12.1,18.55L12,18.65L11.89,18.55C7.14,14.24 4,11.39 4,8.5C4,6.5 5.5,5 7.5,5C9.04,5 10.54,6 11.07,7.36H12.93C13.46,6 14.96,5 16.5,5C18.5,5 20,6.5 20,8.5C20,11.39 16.86,14.24 12.1,18.55M16.5,3C14.76,3 13.09,3.81 12,5.08C10.91,3.81 9.24,3 7.5,3C4.42,3 2,5.41 2,8.5C2,12.27 5.4,15.36 10.55,20.03L12,21.35L13.45,20.03C18.6,15.36 22,12.27 22,8.5C22,5.41 19.58,3 16.5,3Z" style="fill:#1d6ff2"></path></svg>LIKE</button><style data-emotion="css qkt14p">.css-qkt14p{background-color:#e5e8ec;color:#535a65;}.css-qkt14p>img{position:absolute;left:16px;}</style><button class="share-button css-qkt14p ep629fi0"><img src="/icon/share.svg" alt="share" height="20" width="20" class="share-button css-0 ep629fi10"/>SHARE</button></div></section></article></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"next/image 에 대해","slug":"next-image-에-대해","content":"\u003cp\u003eBrand site를 개발하며 SEO를 높히기 위해 기존 Vue.js로 되어있는 프로젝트를 next.js 로 프레임워크를 변경하는 작업을 진행한 경험이 있습니다. 이때 새로운 프레임워크로 Next.js를 선택한 배경으로는 새로운 v10이 나왔기도 했고, 가장 인기있는 프레임워크 중 하나이기 때문입니다.\u003c/p\u003e\n\u003cp\u003eNext.js가 이번 v10이 나오게 되면서 많은 기능들이 추가 되었는데, 그 중 가장 관심이 갔던게 \u003ca href=\"https://nextjs.org/blog/next-10#built-in-image-component-and-automatic-image-optimization\"\u003e\u003ccode\u003enext/image\u003c/code\u003e\u003c/a\u003e 입니다.\u003c/p\u003e\n\u003cpre class=\"language-jsx\"\u003e\u003ccode class=\"language-jsx\"\u003e\u003cspan class=\"token keyword module\"\u003eimport\u003c/span\u003e \u003cspan class=\"token imports\"\u003e\u003cspan class=\"token maybe-class-name\"\u003eImage\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token keyword module\"\u003efrom\u003c/span\u003e \u003cspan class=\"token string\"\u003e'next/image'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003e\u003cspan class=\"token maybe-class-name\"\u003eHome\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token plain-text\"\u003e\n      \u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token plain-text\"\u003eMy Homepage\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token plain-text\"\u003e\n      \u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eImage\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrc\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e/me.png\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003ealt\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003ePicture of the author\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003ewidth\u003c/span\u003e\u003cspan class=\"token script language-javascript\"\u003e\u003cspan class=\"token script-punctuation punctuation\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token number\"\u003e500\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eheight\u003c/span\u003e\u003cspan class=\"token script language-javascript\"\u003e\u003cspan class=\"token script-punctuation punctuation\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token number\"\u003e500\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e/\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token plain-text\"\u003e\n      \u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token plain-text\"\u003eWelcome to my homepage!\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token plain-text\"\u003e\n    \u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword module\"\u003eexport\u003c/span\u003e \u003cspan class=\"token keyword module\"\u003edefault\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eHome\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003enext/image\u003c/code\u003e는 next.js에서 제공하는 이미지 최적화 컴포넌트입니다. \u003ccode\u003eStatic HTML Export\u003c/code\u003e에서는 사용할 수 없는데, 그 이유는 Server에서 돌아가기 때문입니다.\u003c/p\u003e\n\u003ch3\u003e\u003ccode\u003enext/image\u003c/code\u003e가 수행하는 기능은 다음과 같습니다.\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003ewebp 포멧으로 자동변환\u003c/li\u003e\n\u003cli\u003eautomatic lazy-loading\u003c/li\u003e\n\u003cli\u003ecorrect sizing across devices\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e자동 이미지 최적화 기능이 매우 흥미로운데, image request가 들어올 때마다 device 크기별로 이미지 크기(image quality)를 조절해서 보내줍니다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/next-image.png\" alt=\"next-image-header\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003enext/image\u003c/code\u003e header를 살펴보겠습니다.\n실제 이미지는 \u003ccode\u003eimage/bg-kasa.png\u003c/code\u003e path에 있지만 \u003ccode\u003e_next/image\u003c/code\u003e 로 요청된 것을 알 수 있습니다. query를 살펴보면 q=75 로 되어있는데 이는 image-quality를 75%로 보내달라는 것 입니다. 즉, 현재 viewport width가 크지 않으니 100% quality로 보내면 network상 손해이기 때문에 75%로 보내는 것 입니다. 그리고 업로드한 이미지는 파일포멧이 png인데, response headers를 보게되면 \u003ccode\u003eContent-Type: image/webp\u003c/code\u003e 인 것을 확인할 수 있습니다.(webp로 파일포멧 변경)\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003enext/image\u003c/code\u003e를 사용하면 브라우저에서 지원하는 경우 WebP와 같은 최신 형식의 이미지로 변환하여 전송하고, 이미지 크기를 조정하고 최적화할 수 있습니다. 이렇게 하면 viewPort가 더 작은 장치로 큰 이미지가 전송되는 것을 막을 수 있습니다.\u003c/p\u003e\n\u003cp\u003e생성 가능한 총 이미지 수를 줄이기 위해 \u003ccode\u003edeviceSizes\u003c/code\u003e 및 \u003ccode\u003eimageSizes\u003c/code\u003e를 구성 할 수도 있습니다.\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003emodule\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eexports\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  images\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    deviceSizes\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e640\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e750\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e828\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1080\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1200\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1920\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e2048\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e3840\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    imageSizes\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e48\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e64\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e96\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e128\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e384\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003ememory leak\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003enext/image\u003c/code\u003e에서 memory leak 문제가 지속적으로 제기 되었습니다.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/vercel/next.js/issues/20915\"\u003ehttps://github.com/vercel/next.js/issues/20915\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/vercel/next.js/issues/23189\"\u003ehttps://github.com/vercel/next.js/issues/23189\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ccode\u003enext/image\u003c/code\u003e에 의해 최적화된 이미지는 만료일에 도달할 때까지 \u003ccode\u003e\u0026#x3C;distDir\u003e/cache/images\u003c/code\u003e에 캐싱을 하고, 만료가 되면 캐싱된 이미지를 삭제하고 다시 최적화 이미지를 생성한 후 캐싱을 하는 기능이 있는데 이때 캐싱된 이미지를 삭제하는 라이브러리가 제대로 삭제를 시켜주지 않는 문제였습니다.\u003c/p\u003e\n\u003cp\u003enext.js 레포에 v9에서 v10으로 변경한 후 memory 사용량이 비정상적으로 높아졌으며 이로 인해 \u003ccode\u003enext/image\u003c/code\u003e의 image component를 제거해야만 했다라는 이슈가 계속 올라왔습니다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://camo.githubusercontent.com/d88fbdef185b40d56b3a42a699550a469dbaa28f0ca50e2e344644900b972691/68747470733a2f2f692e696d6775722e636f6d2f434b54457863722e706e67\" alt=\"img\"\u003e\n\u003cimg src=\"https://user-images.githubusercontent.com/13972013/104264344-72379580-5459-11eb-8285-7bb2a50adfa5.png\" alt=\"img\"\u003e\n\u003cimg src=\"https://user-images.githubusercontent.com/6556627/105622606-adc25000-5dc7-11eb-8d65-130845bbbbd8.jpeg\" alt=\"img\"\u003e\u003c/p\u003e\n\u003cp\u003e이에 next.js에서는 캐싱하고 삭제하는 라이브러리와 로직을 계속 변경하고 테스트를 하는 중인 것 같습니다.(canary에서 memory-leak 관련 피쳐들이 계속 올라오고 있습니다.)\u003c/p\u003e\n\u003cp\u003e제가 이 문제를 알게된 이유도 현재 next 서버를 돌리고 있는 ecs(Amazon Elastic Container Services)의 cpu와 memory의 사용량이 비정상적인 경우가 존재하였고, image가 pending 상태로 제대로 받아지지 않고 ecs가 비정상적으로 종료되는 문제가 계속 발생했기 때문입니다.\u003c/p\u003e\n\u003cp\u003e다음은 제가 작업한 프로젝트에서 \u003ccode\u003enext/image\u003c/code\u003e를 사용했다가 제거한 후의 cpu, memory 사용량입니다. \u003cstrong\u003e5/11 15:30\u003c/strong\u003e 에 제거한 후 배포를 했는데 확연한 차이를 확인할 수 있습니다. (그래프가 요동치는 곳의 색깔이 화려한데 8개이상의 pod가 비정상적으로 종료되고 실행되었기 때문입니다.)\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/cpu.png\" alt=\"cpu\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/memory.png\" alt=\"memory\"\u003e\u003c/p\u003e\n\u003ch2\u003e마무리\u003c/h2\u003e\n\u003cp\u003e현재 next.js의 stable version은 v10.2.0 입니다. \u003ccode\u003enext/image\u003c/code\u003e는 분명히 좋은 기능이지만 위의 이슈가 해결되지 않는다면 production에서 사용하기에는 어려울 것 같습니다.\u003c/p\u003e","tags":[{"slug":"nextjs","name":"next.js"}]}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"next-image-에-대해"},"buildId":"UE27_0nQ7x29nb1oMBgLl","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-ff94e68042added27a93.js"></script><script src="/_next/static/chunks/main-6ea43f52d44630a19477.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.b4f0be21e3e8c82dd407.js" async=""></script><script src="/_next/static/chunks/b6d3ae6728fbe7f18c7a496885d917c502ef8a97.f1fb57fac8faffcae7e5.js" async=""></script><script src="/_next/static/chunks/82588f7d1c9cede2e30aa92ab94d8815bd9a75a3.d8beab73fc47c8ecaab9.js" async=""></script><script src="/_next/static/chunks/pages/_app-2cd9b9378ad45e0c3d1d.js" async=""></script><script src="/_next/static/chunks/b2e984c5.dde205419b836c367968.js" async=""></script><script src="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.0d2a9ee544564bfee014.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-7d175a24f37cfddaca2b.js" async=""></script><script src="/_next/static/UE27_0nQ7x29nb1oMBgLl/_buildManifest.js" async=""></script><script src="/_next/static/UE27_0nQ7x29nb1oMBgLl/_ssgManifest.js" async=""></script></body></html>
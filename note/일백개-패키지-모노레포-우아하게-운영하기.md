---
title: 일백개 패키지 모노레포 우아하게 운영하기
speaker: 토스, 오창영
description: "토스 전 계열사에서 사용하고 있는 거대한 사내 라이브러리 모노레포의 운영 경험에 대해 공유합니다."
---

## 모노레포란 무엇일까?

- 모노레포란 **잘 정의된 관계**를 가진, 여러개의 독립적인 프로젝트들이 있는 하나의 레포지토리다.

### 왜 모노레포를 사용해야 할까요?

### 문제점
- 새프로젝트 생성 비용이 큼
- 프로젝트간 코드 공유가 어려움
- 같은 이슈를 수정하기 위해 각각의 레포리토리에 커밋이 필요
- 히스토리 관리의 어려움
- 제각각인 툴링으로 개발자 경험이 일관적이지 않음

### 모노레포가 해결해주는것
- 새 프로젝트 생성 비용이 작음
- 프로젝트간 코드 공유가 쉬움
- Atomic commit
- 히스토리 관리가 쉬움
- 공통된 툴링으로 일관적인 개발자 경험

무조껀 하나의 레포에 다 넣으면 얻는것보다 잃는게 큰 경우가 있다.

### Monorepo Feature

#### 속도
- Local computation caching
- Local task orchestration: 같은 머신에서 병렬처리등 효율적으로 관리
- Distributed computation caching: 원격으로 캐싱이 가능
- Detecting affected projects/ packages: 영향받는 프로젝트만 특정 작업을 수행할 수 있게 된다.

#### 관리
- Source code sharing: 프로젝트간 코드공유가 가능
- Code generation: 스캐폴딩이 가능
- Project constraints and visibility: 프로젝트간 의존성관계를 설정할 수 있음

100개 워크스페이스 모노레포 **우아하게 운영하기**

- 해당 모노레포에서만 기술이나 제도적으로 모노레포로 잘 풀어낼 수 있어야 한다.

### 라이브러리 모노레포의 특징

- 토스에서 사용하는 모노레포의 종류

1. Library Only : 커밋수 80 + @, 배포 NPM, 영향범위/커밋 큼
2. Service Monorepo: 커밋수 700 + @, 배포 내부인프라, 영향범위/커밋 작음

### 라이브러리 모노레포이기에 더 중요하게 생각해야 하는 것들

1. 의존성 관리
2. 버전관리
3. 코드 품질 관리
4. 문서화

## 기술적 요구사항

### 1. 의존성관리
- 유령 의존성: 중복설치를 막기위해 디펜던지로 명시되어있지 않는 라이브러리를 불러올 수 있게된다. 혼란을 가중. 최약의 경우 런타임에서 에러가 발생할 수 있다.
- 호이스팅되지않고 yarn .cache에 저장되게 된다.
- .pnp.cjs를 통해 엄격하게 의존성 관리. 명시된 것들만 사용하게 된다.
- zero intall, 빠른 의존성 검색이 가능하다.

peer dependency

- 상속된 디펜던시로 패키지를 사용하는 곳에서 사용해야 하는 디펜던시
- 번들링되면 두개의 디펜던시 2개가 포함될 수 있다.
- 하지만 B가 P의 peer dependencies에 있다면 B를 제공하는 책임이 A가 아닌 P에 있다. 따라서 P를 빌드하면 B가 하나만 포함되게 된다.
- peer dependency는 전파된다. A를 의존하고 있는 모든곳에 peerDependencies를 정의해야한다. 

- 컴파일에서 잡으면 문제없겠지만 엄격하게 잡고있지 않기에 런타임에 문제가 발생할 수 있다.
- 싱글턴으로 존재하는 패키지일때만 PeerDependency를 사용하자.

### 2 버전관리
- semver: major, minor, patch 버전으로 관리가 가능하다. (semver를 잘 지키자)
- 버전관리를 위해 lerna를 사용하여 버전관리하고 있다. 

### 3. 코드 품질 관리
- RFC (Request For Comments) pr을 올리기전 아이디어만으로 라이브러리에 추가하거나 기여하고 싶을 때 설계에 대한 리뷰와 피드백을 받을 수 있다. 설계가 탄탄해질 수 있다. (구현전 단계에서 이슈를 올려서 상세한 리뷰를 받을 수 있다.)
- PR: 라이브러리 오너의 리뷰를 받게 된다. ci로 코드를 검증한다. ci모든 단계를 통과해야 하며 이는 코드 품질을 올릴 수 있다.
  - 피어 디펜던시 에러를 확인할 수 있다. dead code가 있는지 체크한다. 배포전 빌드가 잘 되는지
  - 일종의 테스트 버전의 카나리 배포가 잘되는지
  - 모노레포라 잘 관리될 수 있다.

### 4. 문서화
- RFC와 PR이 각각의 레포에서 관리되면 힘들다. library는 생산성에서 관리되고 있다.
- 라이브러리 사용 가이드가 업으면
- js 도큐사우루스에서 사용이 된다.

- 모노레포에 의해 하나의 config만으로 문서 시스템이 동작한다.



